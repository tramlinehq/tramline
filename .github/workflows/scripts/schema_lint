#!/bin/bash
set -euo pipefail

BASE_REF=$1

# Fetch full diff
git fetch origin "$BASE_REF" --depth=1
CHANGED_FILES=$(git diff --name-only origin/"$BASE_REF"...HEAD)

echo "Files changed in PR:"
echo "$CHANGED_FILES"

# Escape hatch: check if skip comment exists in PR body
PR_BODY=$(gh pr view "$GITHUB_REF_NAME" --json body -q '.body')

if echo "$PR_BODY" | grep -q '#skip-schema-lint'; then
  echo "Skipping schema lint due to '#skip-schema-lint' in PR body"
  exit 0
fi

ERROR=0

# schema.rb must be accompanied by a change in lib/anonymize/
if echo "$CHANGED_FILES" | grep -q '^db/schema\.rb$'; then
  if ! echo "$CHANGED_FILES" | grep -q '^lib/anonymize/'; then
    echo "::error file=db/schema.rb::schema.rb changed — Expected a corresponding change in lib/anonymize/"
    ERROR=1
  fi
fi

# data_schema.rb must be accompanied by a change in db/data_migrate/
if echo "$CHANGED_FILES" | grep -q '^db/data_schema\.rb$'; then
  if ! echo "$CHANGED_FILES" | grep -q '^db/data_migrate/'; then
    echo "::error file=db/data_schema.rb::data_schema.rb changed — Expected a corresponding change in db/data_migrate/"
    ERROR=1
  fi
fi

exit $ERROR
