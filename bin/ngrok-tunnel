#!/bin/sh
# ngrok tunnel startup script for Docker
#
# Creates a tunnel with a stable URL (requires ngrok account + authtoken).
# Free tier gives you a random URL, paid tier can have custom/stable domains.

set -e

# Check if tunneling is explicitly disabled
if [ "$NGROK_DISABLED" = "true" ] || [ "$NGROK_DISABLED" = "1" ]; then
  echo 'ngrok tunnel disabled - skipping'
  rm -f /rails/tmp/tunnel_url
  touch /tmp/ngrok_ready
  exec sleep infinity
fi

# Check for auth token
if [ -z "$NGROK_AUTHTOKEN" ]; then
  echo "WARNING: NGROK_AUTHTOKEN not set - tunnel disabled"
  echo ""
  echo "To enable tunneling:"
  echo "  1. Sign up at https://ngrok.com (free)"
  echo "  2. Get your authtoken from https://dashboard.ngrok.com/get-started/your-authtoken"
  echo "  3. Add to .env.development: NGROK_AUTHTOKEN=your_token_here"
  echo ""
  rm -f /rails/tmp/tunnel_url
  touch /tmp/ngrok_ready
  exec sleep infinity
fi

WEB_PORT="${WEB_PORT:-3000}"
LOG_FILE="/tmp/ngrok.log"

echo "Installing ngrok..."
apk add --no-cache curl jq > /dev/null 2>&1

# Download and install ngrok
curl -sL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz -C /usr/local/bin

echo "Starting ngrok tunnel to localhost:$WEB_PORT..."

# Configure ngrok with authtoken
ngrok config add-authtoken "$NGROK_AUTHTOKEN" 2>/dev/null || true

# Start ngrok in the background
# Using https scheme since Rails is running with SSL
ngrok http "https://localhost:$WEB_PORT" --log=stdout --log-level=info > "$LOG_FILE" 2>&1 &
NGROK_PID=$!

# Wait for ngrok to start and get the URL from the API
echo 'Waiting for tunnel URL...'
RETRIES=0
MAX_RETRIES=30
TUNNEL_URL=''

while [ -z "$TUNNEL_URL" ] && [ $RETRIES -lt $MAX_RETRIES ]; do
  # Check if ngrok is still running
  if ! kill -0 $NGROK_PID 2>/dev/null; then
    echo "ERROR: ngrok process died unexpectedly"
    echo "Log output:"
    cat "$LOG_FILE"
    exit 1
  fi

  # Query ngrok's local API to get the tunnel URL
  TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url // empty' 2>/dev/null || true)

  if [ -z "$TUNNEL_URL" ]; then
    RETRIES=$((RETRIES + 1))
    echo "Tunnel URL not ready yet (attempt $RETRIES/$MAX_RETRIES)..."
    sleep 2
  fi
done

if [ -z "$TUNNEL_URL" ]; then
  echo "ERROR: Failed to get tunnel URL after $MAX_RETRIES attempts"
  echo "Log output:"
  cat "$LOG_FILE"
  exit 1
fi

echo "$TUNNEL_URL" > /rails/tmp/tunnel_url
echo "ngrok tunnel URL is $TUNNEL_URL"
touch /tmp/ngrok_ready

# Keep the script running
wait $NGROK_PID
