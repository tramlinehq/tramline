#!/bin/sh
# Simple tunnel script (currently uses ngrok)

if [ "$NGROK_DISABLED" = "true" ]; then
  echo 'ngrok disabled'
  touch /tmp/localtunnel_ready
  sleep infinity
fi

if [ -z "$NGROK_AUTHTOKEN" ]; then
  echo "ERROR: NGROK_AUTHTOKEN not set in .env.development"
  exit 1
fi

WEB_PORT="${WEB_PORT:-3000}"

apk add --no-cache curl jq > /dev/null 2>&1
curl -sL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz -C /usr/local/bin

ngrok config add-authtoken "$NGROK_AUTHTOKEN"

# Start ngrok in background, wait for URL, then keep running
ngrok http "https://localhost:$WEB_PORT" --log=stdout > /tmp/ngrok.log 2>&1 &

sleep 5
TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
echo "$TUNNEL_URL" > /rails/tmp/tunnel_url
echo "ngrok tunnel: $TUNNEL_URL"
touch /tmp/localtunnel_ready

wait
