#!/bin/sh
# Local tunnel script (currently uses ngrok as the provider)

if [ "$LOCALTUNNEL_DISABLED" = "true" ]; then
  echo 'localtunnel disabled'
  touch /tmp/localtunnel_ready
  sleep infinity
fi

if [ -z "$LOCALTUNNEL_AUTHTOKEN" ]; then
  echo "ERROR: LOCALTUNNEL_AUTHTOKEN not set in .env.development"
  exit 1
fi

WEB_PORT="${WEB_PORT:-3000}"

apk add --no-cache curl jq > /dev/null 2>&1
curl -sL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar xz -C /usr/local/bin

ngrok config add-authtoken "$LOCALTUNNEL_AUTHTOKEN" 2>/dev/null

# Start tunnel in foreground, use a subshell to capture the URL after startup
(
  sleep 5
  TUNNEL_URL=$(curl -s "http://localhost:4040/api/tunnels" | jq -r '.tunnels[0].public_url')
  echo "$TUNNEL_URL" > /rails/tmp/tunnel_url
  echo "localtunnel: $TUNNEL_URL"
  touch /tmp/localtunnel_ready
) &

if [ -n "$LOCALTUNNEL_DOMAIN" ]; then
  exec ngrok http "https://localhost:$WEB_PORT" --url "$LOCALTUNNEL_DOMAIN" --log=stdout
else
  exec ngrok http "https://localhost:$WEB_PORT" --log=stdout
fi
