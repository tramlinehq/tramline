#!/bin/bash
# Get the Tailscale Funnel URL for this worktree/main repo
# Usage: bin/get-tunnel-url

set -e

# Detect if we're in a worktree
if [ -f .git ]; then
  WORKTREE_NAME=$(basename $(pwd))
  COMPOSE_CMD="docker compose -f compose.yml -f compose.worktree.yml"
else
  WORKTREE_NAME="main"
  COMPOSE_CMD="docker compose"
fi

# Try to get the Tailscale status
HOSTNAME="tramline-${WORKTREE_NAME}"
TAILSCALE_URL=$(${COMPOSE_CMD} exec -T tailscale tailscale funnel status 2>/dev/null | grep -o 'https://[^ ]*' | head -1 || echo "")

if [ -n "$TAILSCALE_URL" ]; then
  echo "$TAILSCALE_URL"
else
  # Fallback: try to get from tailscale status
  TAILSCALE_URL=$(${COMPOSE_CMD} exec -T tailscale tailscale status --json 2>/dev/null | jq -r '.Self.DNSName' 2>/dev/null || echo "")
  if [ -n "$TAILSCALE_URL" ]; then
    # Remove trailing dot and add https
    echo "https://${TAILSCALE_URL%.}"
  else
    # Fallback to localhost
    if [ -f .git ]; then
      WEB_PORT=$(printf '%s' "$WORKTREE_NAME" | cksum | cut -d' ' -f1 | awk '{print (($1 % 999) + 1 + 3000)}')
      echo "https://localhost:${WEB_PORT}"
    else
      echo "https://localhost:3000"
    fi
  fi
fi
