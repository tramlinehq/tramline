#!/bin/bash
# Generates unique port offsets for web server based on worktree directory name
# This allows multiple git worktrees to run simultaneously without port conflicts
#
# Only WEB_PORT and NGROK_PORT change per worktree.
# Database, Redis, and Applelink are shared across all worktrees.
#
# When running from the main repo, uses default ports (no offset)
# When running from a worktree, generates a deterministic offset from directory name
#
# Usage:
#   ./bin/worktree-ports --print    # Show ports for this worktree
#   ./bin/worktree-ports --export   # Export as shell variables
#   ./bin/worktree-ports --env      # Output in .env format

set -e

DIR_NAME=$(basename "$(pwd)")

# Detect if we're in a worktree or main repo
# In a worktree, .git is a file; in main repo, .git is a directory
if [ -f ".git" ]; then
  IS_WORKTREE=true
  # Generate a hash-based offset (1-99) from directory name
  OFFSET=$(( ($(printf '%s' "$DIR_NAME" | cksum | awk '{print $1}') % 99) + 1 ))
else
  IS_WORKTREE=false
  OFFSET=0
fi

# Only web and ngrok ports change per worktree
WEB_PORT=$((3000 + OFFSET))
NGROK_PORT=$((4040 + OFFSET))

# Generate hostname - default for main repo, offset-based for worktrees
if [ "$IS_WORKTREE" = true ]; then
  HOST_NAME="tramline${OFFSET}.local.gd"
else
  HOST_NAME="tramline.local.gd"
fi

case "${1:-}" in
  --print)
    if [ "$IS_WORKTREE" = true ]; then
      echo "Worktree: $DIR_NAME"
      echo "Offset:   $OFFSET"
    else
      echo "Main repo: $DIR_NAME"
      echo "Offset:   0 (default ports)"
    fi
    echo ""
    echo "Ports:"
    echo "  WEB_PORT=$WEB_PORT        (https://${HOST_NAME}:${WEB_PORT})"
    echo "  NGROK_PORT=$NGROK_PORT"
    echo ""
    echo "Shared services (same across all worktrees):"
    echo "  POSTGRES_PORT=5442"
    echo "  REDIS_PORT=6389"
    echo "  APPLELINK_PORT=4000"
    echo ""
    echo "Host: $HOST_NAME"
    ;;
  --export)
    echo "export WEB_PORT=$WEB_PORT"
    echo "export NGROK_PORT=$NGROK_PORT"
    echo "export HOST_NAME=$HOST_NAME"
    echo "export WORKTREE_OFFSET=$OFFSET"
    echo "export IS_WORKTREE=$IS_WORKTREE"
    ;;
  --env)
    echo "WEB_PORT=$WEB_PORT"
    echo "NGROK_PORT=$NGROK_PORT"
    echo "HOST_NAME=$HOST_NAME"
    echo "WORKTREE_OFFSET=$OFFSET"
    echo "IS_WORKTREE=$IS_WORKTREE"
    ;;
  *)
    # Default: output for eval $(./bin/worktree-ports)
    echo "WEB_PORT=$WEB_PORT"
    echo "NGROK_PORT=$NGROK_PORT"
    echo "HOST_NAME=$HOST_NAME"
    echo "WORKTREE_OFFSET=$OFFSET"
    echo "IS_WORKTREE=$IS_WORKTREE"
    ;;
esac
