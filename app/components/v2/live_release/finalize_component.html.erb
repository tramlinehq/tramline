<%= render V2::CardComponent.new(title: title, subtitle: subtitle, separator: true) do |card| %>
  <% card.with_actions do %>
    <% if post_release_failed? %>
      <% if completable? %>
        <%= render V2::ButtonComponent.new(
          scheme: :default,
          options: post_release_release_path(release),
          type: :button,
          size: :xxs,
          label: "Wrap up") do |b|
          b.with_icon("v2/zap.svg", size: :sm)
        end %>
      <% else %>
        <%= render V2::ButtonComponent.new(
          scheme: :default,
          options: post_release_release_path(release),
          type: :button,
          size: :xxs,
          label: "Retry") do |b|
          b.with_icon("v2/repeat.svg", size: :sm)
        end %>
      <% end %>
    <% end %>

    <% if post_release_started? %>
      <%= render V2::ButtonComponent.new(
        scheme: :default,
        options: "javascript:window.location.reload();",
        type: :link,
        size: :xxs,
        label: "Refresh") do |b|
        b.with_icon("v2/repeat.svg", size: :sm)
      end %>
    <% end %>
  <% end %>

  <% if post_release_started? %>
    <%= render V2::LoadingIndicatorComponent.new(skeleton_only: true, turbo_frame: false) %>
  <% else %>
    <div class="flex flex-col gap-2 text-sm">
      <p class="<%= strikethrough %>">
        ◦ Cut tag <code><%= release.end_ref %></code> and push
        to <%= link_to_external "GitHub", release.tag_url, class: "underline" %> <%= checked %>
      </p>

      <p class="<%= strikethrough %>">
        ◦ Refresh all the DevOps dashboards and reports <%= checked %>
      </p>

      <p class="<%= strikethrough %>">
        ◦ Create a Pull Request to put all unmerged changes back to main <%= checked %>
      </p>

      <% if post_release_failed? %>
        <div class="flex flex-col items-start item-gap-default">
          <% if open_backmerge_prs? %>
            <%= render V2::AlertComponent.new(type: :error, title: "We couldn't finish this release, please manually merge/close the backmerge PRs and retry.") %>
            <h3 class="heading-5">Backmerge Pull Requests</h3>
            <%= render(V2::PullRequestComponent.with_collection(open_backmerge_prs, simple: true)) %>
          <% elsif open_post_release_prs? %>
            <%= render V2::AlertComponent.new(type: :error, title: "We couldn't automatically finish the release, please manually merge/close the PR and retry.") %>
            <h3 class="heading-5">Backmerge Pull Request</h3>
            <%= render(V2::PullRequestComponent.with_collection(open_post_release_prs, simple: true)) %>
          <% end %>

          <%= render(V2::PullRequestComponent.with_collection(closed_backmerge_prs, simple: true)) %>
          <%= render(V2::PullRequestComponent.with_collection(closed_post_release_prs, simple: true)) %>

          <% if unmerged_changes? %>
            <h3 class="heading-5">Unmerged Changes</h3>
            <div class="text-sm text-main-500">
              <p>There are <%= unmerged_changes.size %> commit(s) that were not automatically merged by
                Tramline.</p>
              <p>You can find the current diff between the
                branches <%= link_to_external "here", release.compare_url, class: "underline" %>.
                Please ensure that these changes have been manually merged back on
                <code><%= release.train.working_branch %></code> before starting the next release.</p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>
