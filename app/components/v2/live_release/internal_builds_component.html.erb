<%= render V2::PlatformViewComponent.new(@release) do |component| %>
  <% component.runs do |release_platform_run| %>
    <% if true %>
      <%= render V2::LiveRelease::SubmissionConfigComponent.new(StoreSubmission.first) %>
    <% else %>
      <%= render V2::EmptyStateComponent.new(
        title: "No internal build step configured",
        text: "Please configure an internal build step for the train to see the build status.",
        banner_image: "v2/drill.svg",
        type: :subdued) %>
    <% end %>
  <% end %>



  <% component.runs do |release_platform_run| %>
    <% if latest_step_run(release_platform_run).present? %>
      <div class="self-start">
        <%= render V2::BadgeComponent.new(**step_status(latest_step_run(release_platform_run)), kind: :status) %>
      </div>
    <% end %>
  <% end %>

  <% component.runs do |release_platform_run| %>
    <%= render V2::CardComponent.new(title: "Current Build") do |card| %>
      <% card.with_actions do %>
        <%= render V2::ModalComponent.new(title: "Changes since last build", size: :xl_3, authz: false) do |modal| %>
          <% button = modal.with_button(label: "Changes since last build", type: :action, scheme: :supporting, size: :xxs) %>
          <% button.with_icon("v2/diff.svg", size: :md) %>
          <% modal.with_body do %>
            <%= render partial: "shared/divide_collection",
                       locals: { collection: render(V2::CommitComponent.with_collection(Build.first.commit.release.all_commits.sample(rand(1..5)))) } %>
          <% end %>
        <% end %>
      <% end %>

      <div class="flex flex-col section-gap-default">
        <%= render V2::LiveRelease::BuildComponent.new(Build.first, show_number: true, show_build_only: false) %>

        <div class="border-l-8 border-green-800 pr-2">
          <div class="flex flex-col items-start gap-2 ml-4">
            <%= render V2::BadgeComponent.new(text: "Internal Beta Team", kind: :badge) do |badge| %>
              <% badge.with_icon("integrations/logo_firebase.png") %>
            <% end %>

            <%= render V2::HorizontalDataSetComponent.new do |component| %>
              <% component.with_data_set(title: "External Status").with_content("In review") %>
              <% component.with_data_set(title: "Released").with_content("One day ago") %>
            <% end %>

            <%= render V2::ButtonComponent.new(label: "Dashboard ↗",
                                               scheme: :link,
                                               type: :link_external,
                                               options: "https://play.google.com/store/apps/details?id=com.example.app",
                                               html_options: { class: "text-sm" },
                                               authz: false,
                                               size: :none) do |b|
              b.with_icon("integrations/logo_google_play_store.png", size: :md)
            end %>

          </div>
        </div>

        <div class="border-l-8 border-red-800 pr-2">
          <div class="flex flex-col items-start gap-2 ml-4">
            <%= render V2::BadgeComponent.new(text: "Internal Beta Team", kind: :badge) do |badge| %>
              <% badge.with_icon("integrations/logo_firebase.png") %>
            <% end %>

            <%= render V2::HorizontalDataSetComponent.new do |component| %>
              <% component.with_data_set(title: "External Status").with_content("Failed review") %>
              <% component.with_data_set(title: "Released").with_content("--") %>
            <% end %>

            <%= render V2::ButtonComponent.new(label: "Dashboard ↗",
                                               scheme: :link,
                                               type: :link_external,
                                               options: "https://play.google.com/store/apps/details?id=com.example.app",
                                               html_options: { class: "text-sm" },
                                               authz: false,
                                               size: :none) do |b|
              b.with_icon("integrations/logo_google_play_store.png", size: :md)
            end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if component.platform_runs.any? { |sr| sr.external_builds.exists? } %>
    <% component.runs do |release_platform_run| %>
      <%= render V2::SectionComponent.new(title: "Build stats", style: :titled, size: :compact) do %>
        <% if step_runs(release_platform_run).any? { |sr| sr.external_build.present? } %>
          <%= render BuildHealthComponent.new(step: review_step(release_platform_run), release_platform_run:, show_title: false) %>
        <% else %>
          <%= render V2::EmptyStateComponent.new(
            title: "No stats for this platform",
            text: "Use the Tramline API to send build stats to get them plotted here.",
            banner_image: "v2/drill.svg",
            type: :subdued) %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <% component.runs do |release_platform_run| %>
    <% if previous_step_runs(release_platform_run).present? %>
      <%= render V2::SectionComponent.new(title: "Older builds (#{previous_step_runs(release_platform_run).size})", style: :titled, size: :compact) do %>
        <div class="flex flex-col item-gap-default">
          <% previous_step_runs(release_platform_run).each do |step_run| %>
            <%= render V2::AccordionComponent.new(push_down: true) do |accordion| %>
              <% accordion.with_title_section do %>
                <div class="flex text-sm items-center justify-between">
                  <div class="flex gap-2">
                    <span><%= step_run.build_display_name %></span>
                    <%= render V2::BadgeComponent.new(**step_status(step_run)) %>
                  </div>

                  <div class="flex items-center">
                    <%= inline_svg("v2/dotted_line.svg", classname: "w-4 h-4 inline-flex mx-2 text-secondary") %>
                    <span class="text-secondary font-normal"><%= ago_in_words(step_run.created_at) %></span>
                  </div>
                </div>
              <% end %>

              <div class="my-3">
                <%= render V2::LiveRelease::DeprecatedBuildComponent.new(step_run:, release_platform_run:, compact: true) %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% end %>
  <% end %>
<% end %>
