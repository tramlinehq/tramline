<div class="mb-7">
  <% if editable? %>
    <%= render AlertComponent.new(type: :info, title: "You can edit the release notes until the review process has begun on the stores.", full_screen: false) %>
  <% else %>
    <%= render AlertComponent.new(kind: :announcement, type: :announce, title: "Release notes cannot be edited") do %>
      ❌ You can't edit the release notes once the review process has begun on the stores.
    <% end %>
  <% end %>
</div>

<%= render FormComponent.new(model: ReleaseMetadata.new(release: @release), url: update_metadata_path, method: :patch, data: {turbo: false}, free_form: true) do |f| %>
  <div>
    <div class="flex flex-col gap-y-2 mb-6">
      <div class="flex gap-x-4">
        <%= render ButtonComponent.new(label: "Play Store metadata requirements",
                                       scheme: :link,
                                       type: :link_external,
                                       options: "https://play.google.com/console/about/storelistings/#best-practices",
                                       html_options: {class: "text-sm"},
                                       authz: false,
                                       size: :none,
                                       arrow: :none) do |b|
              b.with_icon("integrations/logo_google_play_store.png", size: :md, classes: "text-main")
            end %>

        <%= render ButtonComponent.new(label: "App Store Connect metadata requirements",
                                       scheme: :link,
                                       type: :link_external,
                                       options: "https://help.apple.com/asc/appsspec/en.lproj/static.html",
                                       html_options: {class: "text-sm"},
                                       authz: false,
                                       size: :none,
                                       arrow: :none) do |b|
              b.with_icon("integrations/logo_app_store.png", size: :md, classes: "text-main")
            end %>
      </div>

      <div class="flex flex-row justify-between">
        <div class="flex flex-row items-center justify-start gap-x-3"
             data-controller="stream-effect"
             data-stream-effect-url-value="<%= edit_metadata_url %>"
             data-stream-effect-param-value="language">
          <%= render IconComponent.new("languages.svg", size: :xxl) %>
          <%= select_tag :language,
                         options_for_select(active_languages, language),
                         disabled: false,
                         class: EnhancedFormHelper::AuthzForm::SELECT_CLASSES,
                         data: {action: "change->stream-effect#fetch", stream_effect_target: "dispatch"} %>
        </div>

        <div class="flex flex-row justify-end gap-x-2">
          <div>
            <%= render ButtonComponent.new(
                  scheme: :light,
                  options: root_path,
                  type: :link,
                  disabled: true,
                  size: :xxs,
                  label: "Copy to all locales",
                  html_options: {data: {turbo_confirm: "This will copy the release notes to all locales, are you sure?"}}
                ) do |b|
                  b.with_icon("square_stack.svg", size: :sm)
                end %>
          </div>

          <div>
            <%= f.F.authz_submit "Save current locale", "archive.svg", size: :xxs, disabled: !editable? %>
          </div>
        </div>
      </div>

      <div class="text-secondary text-xs">
        † The languages in this list are the locales set for your app or the ones that have been recently used.
      </div>
      <div class="text-secondary text-xs">
        Now editing — <span class="font-semibold tracking-wide"><%= language %></span>
      </div>
    </div>

    <%= render PlatformViewComponent.new(@release) do |component| %>
      <% if android_metadata %>
        <% f.F.fields_for :android, android_metadata do |aF| %>
          <div class="flex flex-col gap-y-4">
            <%= aF.hidden_field :id %>
            <div data-controller="text-applier" data-text-applier-content-value="<%= android_draft_notes %>">
              <% if android_has_draft_notes? %>
                <%= render partial: "release_metadata/draft_alert", locals: {title: "Unsaved release notes", field_name: "release notes"} %>
              <% end %>
              <div data-text-applier-target="input">
                <%= render partial: "shared/size_limited_textarea", locals: {form: aF,
                                                                             obj_method: :release_notes,
                                                                             label_text: "Release Notes",
                                                                             max_length: android_max_length,
                                                                             existing_value: android_metadata.release_notes} %>
              </div>
            </div>
          </div>
        <% end %>
      <% elsif component.cross_platform? %>
        <div class="flex flex-col gap-y-4">
          <%= render no_locale_set %>
        </div>
      <% end %>

      <% if ios_metadata %>
        <% f.F.fields_for :ios, ios_metadata do |iosF| %>
          <div class="flex flex-col gap-y-4">
            <%= iosF.hidden_field :id %>
            <div data-controller="text-applier" data-text-applier-content-value="<%= ios_draft_notes %>">
              <% if ios_has_draft_notes? %>
                <%= render partial: "release_metadata/draft_alert", locals: {title: "Unsaved release notes", field_name: "release notes"} %>
              <% end %>
              <div data-text-applier-target="input">
                <%= render partial: "shared/size_limited_textarea", locals: {form: iosF,
                                                                             obj_method: :release_notes,
                                                                             label_text: "Release Notes",
                                                                             max_length: ios_max_length,
                                                                             existing_value: ios_metadata.release_notes} %>
              </div>
            </div>
            <div data-controller="text-applier" data-text-applier-content-value="<%= ios_draft_promo_text %>">
              <% if ios_has_draft_promo_text? %>
                <%= render partial: "release_metadata/draft_alert", locals: {title: "Unsaved promo text", field_name: "promo text"} %>
              <% end %>
              <div data-text-applier-target="input">
                <%= render partial: "shared/size_limited_textarea", locals: {form: iosF,
                                                                             obj_method: :promo_text,
                                                                             label_text: "Promo Text",
                                                                             max_length: promo_text_max_length,
                                                                             existing_value: ios_metadata.promo_text} %>
              </div>
            </div>
            <div>
              <div data-controller="character-counter" data-character-counter-max-length-value="<%= keywords_max_length %>">
                <div class="flex items-center gap-1.5">
                  <%= iosF.label_only :keywords, "Keywords", type: :base %>
                  <%= render InfoIconComponent.new do %>
                    <p>Use accurate, relevant comma-separated keywords. Avoid categories, trademarks, competitor app names, or terms not tied to your app.</p>
                    <p class="mt-1">
                      <%= link_to_external "Read more",
                                           "https://developer.apple.com/app-store/search/#:~:text=Choose%20accurate%20keywords%20that%20resonate,part%20of%20your%20brand%20identity",
                                           class: "underline" %> about proper use of keywords.
                    </p>
                  <% end %>
                </div>
                <%= iosF.textarea :keywords,
                                  placeholder: "Write keywords here",
                                  value: ios_metadata.keywords_joined,
                                  data: {character_counter_target: "input",
                                         action: "input->character-counter#update",
                                         controller: "textarea-autogrow"} %>
                <p class="text-xs text-secondary">
                  Characters –
                  <strong data-character-counter-target="counter"><%= ios_metadata.keywords_joined&.length || 0 %></strong>
                  / <%= keywords_max_length %>
                </p>
              </div>
            </div>
            <div>
              <%= render partial: "shared/size_limited_textarea", locals: {form: iosF,
                                                                           obj_method: :description,
                                                                           label_text: "Description",
                                                                           max_length: description_max_length,
                                                                           existing_value: ios_metadata.description} %>
            </div>
          </div>
        <% end %>
      <% elsif component.cross_platform? %>
        <div class="flex flex-col gap-y-4">
          <%= render no_locale_set %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
