<%= render CardComponent.new(title: "Active Release Candidate", size: :full, separator: true) do |card| %>
  <% if @release.soak_period_active? && current_user == @release.release_pilot %>
    <% card.with_action do %>
      <%= button_to "End soak", end_soak_release_path(@release), method: :post,
          data: {turbo_confirm: "Are you sure you want to end the soak period early?"},
          form: {class: "inline"} %>
    <% end %>
    <% card.with_action do %>
      <%= button_to "Extend soak", extend_soak_release_path(@release, additional_hours: 24), method: :post,
          data: {turbo_confirm: "Extend soak period by 24 hours?"},
          form: {class: "inline"} %>
    <% end %>
  <% end %>
  <div class="flex flex-col section-gap-default">
    <%= render PlatformViewComponent.new(@release) do |component| %>
      <% component.platform_runs.each do |run| %>
        <% if run.latest_beta_release.present? %>
          <div class="grid grid-cols-1">
            <div class="flex flex-col item-gap-default">
              <%= render LiveRelease::BuildComponent.new(run.latest_beta_release.build) %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <% if @release.soak_started_at.present? %>
      <% time_remaining_hours = @release.soak_time_remaining / 3600.0 %>
      <div data-controller="countdown"
           data-countdown-count-down-hours-value="<%= time_remaining_hours %>"
           data-countdown-direction-value="down"
           class="flex justify-center items-center border-default box-padding">
        <div class="flex flex-col item-gap-default items-center">
          <div class="text-md text-secondary">Time remaining</div>
          <% if @release.soak_period_completed? %>
            <div class="text-2xl">Soak period has ended</div>
          <% else %>
            <div class="text-4xl" data-countdown-target="output">
              <%= Time.at(@release.soak_time_remaining).utc.strftime("%H:%M:%S") %>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="flex justify-center items-center border-default box-padding">
        <div class="flex flex-col item-gap-default items-center">
          <div class="text-md text-secondary">Soak period will start when RC is available</div>
          <div class="text-2xl">Waiting for Release Candidate</div>
        </div>
      </div>
    <% end %>

    <div class="flex flex-col text-secondary text-xs">
      <div>† Soak starts as soon as an active Release Candidate is available.</div>
      <div>‡ App submission will be enabled once your configured <%= @release.soak_period_hours %>-hour soak period ends.</div>
      <% if @release.soak_started_at.present? && !@release.soak_period_completed? %>
        <div>‡ Soak period started at <%= @release.soak_started_at.strftime("%Y-%m-%d %H:%M %Z") %> and will end at <%= @release.soak_end_time.strftime("%Y-%m-%d %H:%M %Z") %>.</div>
      <% end %>
      <% if @release.soak_period_active? && current_user != @release.release_pilot %>
        <div class="mt-2 text-warning">Note: Only the release pilot can end or extend the soak period.</div>
      <% end %>
    </div>
  </div>
<% end %>
