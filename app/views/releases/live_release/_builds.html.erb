<section>
  <div class="flex">
    <h2 class="font-bold text-2xl">All commits</h2>
  </div>

  <% commits_count = release.commits.size %>

  <table class="table-auto w-full mt-4">
    <thead class="text-xs font-semibold uppercase text-slate-500 bg-slate-50 border-t border-b border-slate-200">
    <tr>
      <th class="px-2 py-3 whitespace-nowrap">
        <div class="font-semibold text-left">commits</div>
      </th>

      <th class="py-3 whitespace-nowrap"><!-- build details accordion --></th>
    </tr>
    </thead>

    <% release.commits.order(created_at: :desc).includes(step_runs: :step).each_with_index do |commit, index| %>
      <% is_stale_commit = commit.stale? %>
      <tbody class="text-sm border-b last:border-b-0" data-controller="reveal" data-reveal-toggle-keys-value="b">

      <tr>
        <td class="py-4 whitespace-nowrap">

          <%
            if is_stale_commit
              link_text_class = "text-slate-400"
              number_text_class = "bg-slate-100 text-slate-400"
            else
              link_text_class = "font-medium"
              number_text_class = "bg-slate-200 text-slate-600"
            end
          %>

          <%= link_to_external commit.message.truncate(50), commit.url, class: "underline #{link_text_class}" %>
          <span class="text-xs uppercase tracking-wide inline-flex font-medium <%= number_text_class %> rounded-full text-center px-2 py-0.5">
            #<%= commits_count - index %>
          </span>

          <div class="mt-1 text-slate-500">
            <%= commit.short_sha %> • <%= ago_in_words commit.timestamp %>
          </div>
        </td>
        <td class="align-text-top pt-4 whitespace-nowrap w-px">
          <button
            class="text-slate-400 hover:text-slate-500 transform"
            data-action="reveal#toggle">

            <div class="flex truncate">
              <span class="truncate mx-2 font-medium text-slate-500 group-hover:text-slate-800 underline">Details</span>
              <svg class="w-3 h-3 shrink-0 ml-1 mt-1 fill-current text-slate-500 group-hover:text-slate-800 rotate-0" viewBox="0 0 12 12">
                <path d="M5.9 11.4L.5 6l1.4-1.4 4 4 4-4L11.3 6z"/>
              </svg>
            </div>
          </button>
        </td>
      </tr>

      <tr data-reveal <%= "hidden" if is_stale_commit %>>
        <td colspan="2" class="pb-4 whitespace-nowrap">
          <div class="grid grid-cols-1 gap-y-1 ml-4">
            <% if is_stale_commit %>
              <span class="font-medium mb-2">This commit has been replaced by a newer commit.</span>
            <% end %>

            <% commit.step_runs.includes(:step).order(:created_at).each_with_index do |step_run| %>
              <div class="border-dashed border-t last:border-t-0 mb-2"></div>

              <div class=" pt-2 <%= "opacity-50" if is_stale_commit %>">
                <div class="mb-2 font-medium">
                  <%= step_run.step.name %>
                  <%= dev_show { step_run.id.strip } %>
                </div>

                <!-- per step info -->
                <div>
                  <div class="mb-2">
                    <% if step_run.ci_link.present? %>
                      <%= link_to_external "CI workflow run ↗", step_run.ci_link, class: "underline" %>
                    <% else %>
                      CI workflow running
                    <% end %>

                    <span class="ml-1"><%= build_status_badge(step_run) %></span>
                    <% if step_run.fetching_build? %>
                      <%= status_badge("Waiting for build", %w[bg-green-500 hover:bg-green-600 text-white], pulse: true) %>
                    <% end %>
                  </div>

                  <% if step_run.build_artifact_available? %>
                    <div class="mb-2">
                      <%= link_to_external "Download build ↗", step_run.download_url, class: "underline" %>
                      <div class="text-slate-500">
                        <div>
                          version <span class="font-mono"><%= step_run.build_version %></span>
                          • build <span class="font-mono"><%= step_run.build_number %></span>
                        </div>
                        <div>
                          <%= "built " + ago_in_words(step_run.build_artifact&.generated_at) %>
                          • <%= "uploaded " + ago_in_words(step_run.build_artifact&.uploaded_at) %>
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <% if step_run.deployment_runs.exists? %>
                    <div class="mb-2">
                      <%= Deployment.display.pluralize %>
                      <% step_run.deployment_runs.each do |deployment_run| %>
                        <% deployment = deployment_run.deployment %>

                        <div>
                          <span class="mr-1">
                            <%= image_tag("arrow-right.svg", width: 16, class: "inline-flex mr-1") %>
                            <%= render partial: "shared/deployment", locals: { deployment: deployment } %>
                          </span>

                          <%= deployment_run_status_badge(deployment_run) %>

                          <% if deployment.store? && deployment_run.released? && !deployment_run.ios? %>
                            <div class="text-xs ml-4 mt-2">
                              <%= image_tag("corner_down_right.svg", width: 10, class: "inline-flex mr-1") %>
                              <span>
                                Released to: <%= number_to_percentage deployment_run.rollout_percentage %>
                                of the users
                              </span>
                            </div>
                          <% end %>

                          <%= render partial: "releases/live_release/external_build", locals: { deployment_run: } %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>

                  <div class="mb-2">
                    <% unless release.train.sign_off_groups.blank? %>
                      <div>
                        <span class="font-medium">Approval Status:</span> <%= approval_emoji(step_run) %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </td>
      </tr>
      </tbody>
    <% end %>
  </table>
</section>
