<% breadcrumb :release, @release %>

<div class="sm:flex sm:justify-between sm:items-center pb-8 border-b border-slate-200">
  <!-- Left: Title -->
  <div class="mb-4 sm:mb-0">
    <p class="text-2xl md:text-3xl text-slate-800 font-bold"><%= @release.release_version %></p>
  </div>

  <!-- Right: Actions -->
  <div class="grid grid-flow-col sm:auto-cols-max justify-start sm:justify-end gap-2">
    <% if @release.on_track? %>
      <%= button_to "Stop release", release_path(@release.id), method: :delete, class: "btn bg-red-500 hover:bg-red-600 text-white" %>
    <% end %>
  </div>
</div>

<section class="mt-8">
  <div class="flex">
    <h2 class="font-bold text-2xl">Pre-release PRs</h2>
  </div>
  <% if @pre_release_prs&.exists? %>
    <div class="grid grid-cols-5 gap-6 mt-4">
      <% @pre_release_prs.each do |pr| %>
        <div class="mt-2 bg-white rounded-sm border border-slate-200 p-4">
          <%= image_tag("#{pr.source}_thumb.png", width: 40, class: "mb-4") %>

          <div class="h-full">
            <h2 class="font-semibold text-slate-800">
              <%= pr.title %><span class="ml-1 underline">(#<%= link_to pr.number, pr.url, target: :_blank %>)</span>
            </h2>

            <div class="mt-2">
              <%= image_tag("git_pull_request.svg", width: 20, class: "inline-flex") %>

              <div class="text-xs inline-flex font-medium <%= pull_request_badge(pr.state) %> rounded-full text-center px-2.5 py-1">
                <%= pr.state.titleize %>
              </div>
            </div>

            <% if pr.closed_at.nil? %>
              <div class="text-sm mt-2">Opened at – <%= pr.opened_at.to_s(:short) %></div>
            <% else %>
              <div class="text-sm mt-2">Closed at – <%= pr.closed_at.to_s(:short) %></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-sm mt-4">
      None.
    </div>
  <% end %>
</section>

<section class="border-t border-dashed border-slate-200 pt-8 mt-8">
  <div class="flex">
    <h2 class="font-bold text-2xl">Kick-off</h2>
    <span class="text-2xl text-slate-400 ml-4"><%= time_ago_in_words(@release.created_at) %> ago</span>
  </div>

  <div class="grid md:grid-cols-2 gap-y-4 mt-4">
    <div>
      <div class="font-bold text-slate-600 text-sm uppercase mb-1">Release branch</div>
      <code><%= link_to @release.branch_name, @release.branch_url, target: :_blank %></code>
    </div>

    <div>
      <div class="font-bold text-slate-600 text-sm uppercase mb-1">Branching Strategy</div>
      <span><%= @train.branching_strategy_name %></span>
    </div>

    <% unless @train.sign_off_groups.blank? %>
      <div>
        <div class="font-bold text-slate-600 text-sm uppercase mb-1">Sign-off groups</div>
        <span><%= @train.sign_off_groups.map(&:name).join(", ") %></span>
      </div>
    <% end %>
  </div>
</section>

<section class="border-t border-dashed border-slate-200 pt-8 mt-8">
  <div class="flex">
    <h2 class="font-bold text-2xl">Stability</h2>
    <span class="text-2xl text-slate-400 ml-4"><%= time_ago_in_words(@release.updated_at) %> ago</span>
  </div>
  <div class="flex flex-col mt-4">
    <ul>
      <% @train.steps.order(:step_number).includes(:train, :runs).each do |step| %>
        <% step_run = @release.last_run_for(step) %>
        <li class="relative py-2">
          <!-- Step symbol, name, action button -->
          <div class="flex items-center mb-4">
            <% unless step.last? %>
              <div class="absolute left-0 h-full w-0.5 bg-slate-200 self-start ml-2.5 -translate-x-1/2 translate-y-3" aria-hidden="true"></div>
            <% end %>

            <% if step_run&.approval_approved? && step_run.finished? %>
              <!-- approved and finished -->
              <div class="absolute left-0 rounded-full bg-indigo-500" aria-hidden="true">
                <svg class="w-5 h-5 fill-current text-white" viewBox="0 0 20 20">
                  <path d="M14.4 8.4L13 7l-4 4-2-2-1.4 1.4L9 13.8z"></path>
                </svg>
              </div>
            <% elsif step_run&.on_track? %>
              <!-- on_track -->
              <div class="absolute left-0 rounded-full bg-slate-500" aria-hidden="true">
                <svg class="w-5 h-5 fill-current text-white" viewBox="0 0 20 20">
                  <path d="M14.4 8.4L13 7l-4 4-2-2-1.4 1.4L9 13.8z"></path>
                </svg>
              </div>
            <% else %>
              <!-- not on_track, not finished, not approved -->
              <div class="absolute left-0 rounded-full bg-white" aria-hidden="true">
                <svg class="w-5 h-5 fill-current text-slate-400" viewBox="0 0 20 20">
                  <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 2C4.477 20 0 15.523 0 10S4.477 0 10 0s10 4.477 10 10-4.477 10-10 10z"></path>
                </svg>
              </div>
            <% end %>

            <p class="text-lg font-bold text-slate-800 pl-9"><%= step.name %></p>

            <% if @release.on_track? && step.startable? %>
              <%= button_to 'Move to this step',
                            start_release_step_run_path(@release, step),
                            { class: 'btn-xs ml-4 bg-indigo-500 hover:bg-indigo-600 text-white' } %>
            <% end %>
          </div>

          <!-- Step metadata -->
          <div class="pl-9">
            <% if step_run&.build_version %>
              <div class="flex items-center mb-2">
                <span class="mr-2 text-lg"><%= step_run&.build_version %></span>
                <span class="text-xs uppercase tracking-wide inline-flex font-medium bg-indigo-100 text-indigo-600 rounded-full text-center px-2 py-0.5">Latest build</span>
              </div>
            <% end %>

            <% if @release.on_track? && step_run&.finished? %>
              <% is_current_step = (@release.current_step == step.step_number) %>
              <!-- Sign offs -->
              <div class="flex flex-col w-1/3 bg-amber-50 rounded-lg p-4 mb-2">
                <% if step_run.approval_approved? && (@release.finished? || !is_current_step) %>
                  <span>This step has been approved</span>
                <% elsif step_run.approval_rejected? && (@release.finished? || !is_current_step) %>
                  <span>This step has been rejected</span>
                <% else %>
                  <div class="font-bold text-slate-600 text-sm uppercase mb-1">Sign-offs</div>
                  <% @train.sign_off_groups.each do |group| %>
                    <div class="flex items-center justify-between mb-2">
                      <span class=""><%= group.name %></span>
                      <span class="grid grid-flow-col gap-2">
                      <% if !step_run&.sign_required? || step.sign_offs.exists?(sign_off_group: group, signed: false, commit: step_run&.commit) %>
                        <%= button_to "Approve", approve_step_sign_off_path(step),
                                      params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                      class: 'btn border-slate-200 hover:border-slate-300 text-green-500' %>
                          <%= button_to "Revert", revert_step_sign_off_path(step),
                                        params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                        class: 'btn border-slate-200 hover:border-slate-300 text-slate-600',
                                        method: :delete %>

                      <% elsif step.sign_offs.exists?(sign_off_group: group, signed: true, commit: step_run&.commit) %>
                        <%= button_to "Reject", reject_step_sign_off_path(step),
                                      params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                      class: 'btn border-slate-200 hover:border-slate-300 text-rose-500' %>
                          <%= button_to "Revert", revert_step_sign_off_path(step),
                                        params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                        class: 'btn border-slate-200 hover:border-slate-300 text-slate-600',
                                        method: :delete %>
                      <% else %>
                        <%= button_to "Approve", approve_step_sign_off_path(step),
                                      params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                      class: 'btn border-slate-200 hover:border-slate-300 text-green-500' %>
                          <%= button_to "Reject", reject_step_sign_off_path(step),
                                        params: { sign_off_group_id: group.id, commit_id: step_run&.commit },
                                        class: 'btn border-slate-200 hover:border-slate-300 text-rose-500' %>
                      <% end %>
                      </span>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </li>
      <% end %>
      <div class="pl-9">
        <% if (@release.on_track? || @release.post_release?) && @release.signed? && @release.finished_steps? %>
          <%= button_to "Move to Finalize phase",
                        post_release_app_train_releases_path(@app, @train),
                        class: 'btn-sm bg-indigo-500 hover:bg-indigo-600 text-white' %>
        <% end %>
      </div>
    </ul>
  </div>

  <!-- Builds -->
  <p class="font-bold text-xl mt-8 mb-2">All builds</p>
  <% commits_count = @release.commits.size %>
  <table class="table-auto w-full">
    <thead class="text-xs font-semibold uppercase text-slate-500 bg-slate-50 border-t border-b border-slate-200">

    <tr>
      <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
        <div class="font-semibold text-left">•</div>
      </th>

      <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
        <div class="font-semibold text-left">commit id</div>
      </th>

      <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
        <div class="font-semibold text-left">commit message</div>
      </th>

      <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
        <div class="font-semibold text-left">builds</div>
      </th>
    </tr>
    </thead>

    <tbody class="text-sm divide-y divide-slate-200">
    <% @release.commits.order(created_at: :desc).includes(step_runs: :step).each_with_index do |commit, index| %>
      <tr>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <%= commits_count - index %>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <%= link_to commit.commit_hash[0, 5], commit.url %>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <span class="underline"><%= link_to commit.message, commit.url %></span>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="grid grid-cols-2 gap-y-1">
            <% commit.step_runs.order(:created_at).each_with_index do |step_run| %>
              <div>
                <span class="mx-2">
                  <% if step_run.ci_link.present? %>
                    <%= link_to step_run.step.name, step_run.ci_link, class: "underline", target: :_blank %>
                  <% else %>
                    <%= step_run.step.name %>
                  <% end %>
                </span>

                <%= build_status_badge(step_run.status) %>
              </div>

              <div><%= approval_emoji(step_run.approval_status) %> <%= step_run.build_version %></div>
            <% end %>
          </div>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
</section>

<section class="border-t border-dashed border-slate-200 pt-8 mt-8">
  <div class="flex">
    <h2 class="font-bold text-2xl">Finalize</h2>
    <% unless @release.signed? %>
      <span class="text-2xl text-slate-400 ml-4">pending approvals</span>
    <% end %>
  </div>

  <% if @release.completed_at.present? %>
    <div class="mt-4 bg-slate-50 border border-slate-200 ">
      <div class="py-8 px-8 lg:px-8">
        <div class="max-w-sm mx-auto lg:max-w-none">
          <div class="text-slate-800 font-bold text-center mb-6 animate-bounce">
            ↯ Great work team! This release is complete! ↯
          </div>
          <!-- Details -->
          <div class="mt-8">
            <div class="mt-6 text-sm font-semibold text-slate-800 mb-1">Release Summary</div>
            <ul class="mt-3">
              <li class="flex items-center justify-between py-3 border-b border-slate-200">
                <div class="text-sm">Total Run Time</div>
                <div class="text-sm font-medium text-slate-800 ml-2">
                  <%= finalize_phase_metadata(@release).dig(:total_run_time) %>
                </div>
              </li>
              <li class="flex items-center justify-between py-3 border-b border-slate-200">
                <div class="text-sm">Release Tag</div>
                <div class="flex items-center whitespace-nowrap">
                  <%= image_tag("git_tag.svg", width: 20, class: "inline-flex mr-2") %>
                  <div class="text-sm font-mono text-slate-800">
                    <%= link_to finalize_phase_metadata(@release).dig(:release_tag),
                                finalize_phase_metadata(@release).dig(:release_tag_url) %>
                  </div>
                </div>
              </li>
              <li class="flex items-center justify-between py-3 border-b border-slate-200">
                <div class="text-sm">Final Release Build</div>
                <div class="flex items-center whitespace-nowrap">
                  <%= image_tag("link.svg", width: 20, class: "inline-flex mr-2") %>
                  <div class="text-sm font-mono text-slate-800">
                    <%= link_to "Download Artifact", finalize_phase_metadata(@release).dig(:final_artifact_url) %>
                  </div>
                </div>
              </li>
              <li class="flex items-center justify-between py-3">
                <div class="text-sm">Store Link</div>
                <div class="flex items-center whitespace-nowrap">

                  <div class="text-sm font-mono text-slate-800">
                    <%= link_to image_tag("link_external.svg", width: 20, class: "inline-flex mr-2"),
                                finalize_phase_metadata(@release).dig(:store_url), target: "_blank" %>
                  </div>
                </div>
              </li>
            </ul>
            <% if @post_release_prs&.exists? %>
              <div class="mt-6">
                <div class="text-sm font-semibold text-slate-800 mb-1">Pull Requests</div>
              </div>
              <div class="grid grid-cols-4 gap-5 mt-3">
                <% @post_release_prs.each do |pr| %>
                  <div class="mt-2 bg-white rounded-sm border border-slate-200 p-4">
                    <%= image_tag("#{pr.source}_thumb.png", width: 40, class: "mb-4") %>

                    <div class="h-full">
                      <h2 class="font-semibold text-slate-800">
                        <%= pr.title %>
                        <span class="ml-1 underline">(#<%= link_to pr.number, pr.url, target: :_blank %>)</span>
                      </h2>

                      <div class="mt-2">
                        <%= image_tag("git_pull_request.svg", width: 20, class: "inline-flex") %>

                        <div class="text-xs inline-flex font-medium <%= pull_request_badge(pr.state) %> rounded-full text-center px-2.5 py-1">
                          <%= pr.state.titleize %>
                        </div>
                      </div>

                      <div class="font-mono text-xs mt-2">
                        <%= pr.base_ref %> ← <%= pr.head_ref %>
                      </div>

                      <% if pr.closed_at.nil? %>
                        <div class="text-sm mt-2">Opened at – <%= pr.opened_at.to_s(:short) %></div>
                      <% else %>
                        <div class="text-sm mt-2">Closed at – <%= pr.closed_at.to_s(:short) %></div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</section>
