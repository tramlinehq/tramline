<% breadcrumb :train, @train %>

<%= render partial: 'shared/errors', locals: { resource: @train } %>

<div class="sm:flex sm:justify-between sm:items-center pb-8 border-b border-slate-200">
  <div class="mb-4 sm:mb-0">
    <p class="text-2xl md:text-3xl text-slate-800 font-bold"><%= @train.name %> ðŸš¦</p>
  </div>

  <div class="grid grid-flow-col sm:auto-cols-max justify-start sm:justify-end gap-2">
    <% if @train.active_run %>
      <%= decorated_link_to :green, "Ongoing Release", live_release_app_train_releases_path(@app, @train) %>
    <% elsif @train.startable? %>
      <%= authz_button_to :blue, "Start new release", app_train_releases_path(@app, @train) %>
    <% end %>

    <% if @train.runs.size > 0 %>
      <%= button_to "#", class: "btn bg-indigo-500 hover:bg-indigo-600 text-white disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed shadow-none", disabled: true do %>
        <%= inline_svg("band_aid.svg",  classname: "w-5 h-5 opacity-80") %>
        <span class="ml-2">Hotfix last release</span>
      <% end %>
    <% end %>

    <%= authz_link_to :neutral, edit_app_train_path(@app, @train) do %>
      <%= inline_svg("edit.svg", classname: "w-4 h-4 fill-current text-slate-500 shrink-0") %>
      <span class="ml-2">Settings</span>
    <% end %>

    <% if @train.runs.blank? %>
      <%= authz_link_to :red, app_train_path(@app, @train), method: :delete,
                        data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } do %>
        <span>Delete</span>
      <% end %>
    <% end %>
  </div>
</div>

<section class="mt-8">
  <div class="grid md:grid-cols-2 gap-y-4 mt-4">
    <div>
      <div class="font-bold text-slate-600 text-sm uppercase mb-1">Branching Strategy</div>
      <span><%= @train.branching_strategy_name %></span>
    </div>

    <% unless @train.description.blank? %>
      <div>
        <div class="font-bold text-slate-600 text-sm uppercase mb-1">Description</div>
        <span><%= simple_format @train.description %></span>
      </div>
    <% end %>
  </div>
</section>

<!--Steps-->
<h2 class="text-2xl font-bold mt-8 mb-4">Steps</h2>

<% if @train.steps.size > 0 %>
  <div class="flex flex-col">
    <%= render partial: "shared/step_tree_viz", locals: { train: @train, editable: false } %>
  </div>
<% else %>
  <%= render partial: "trains/step_creation", locals: { app: @app, train: @train } %>
<% end %>

<!--Releases-->

<% releases_count = @train.runs.size %>

<% if releases_count > 0 %>
  <%= render TableComponent.new(columns: ["â€¢", "version", "release branch", "final deployment channel"]) do |table| %>
    <% table.with_heading do %>
      <h2 class="text-2xl font-bold mt-8 mb-4">Releases</h2>
    <% end %>

    <% @train.runs.order(scheduled_at: :desc).each_with_index do |run, index| %>
      <% table.with_row do |row| %>
        <% row.with_cell do %>
          <%= releases_count - index %>
        <% end %>
        <% row.with_cell do %>
          <%= link_to release_path(run.id) do %>
            <span class="underline">
              <% if run.completed_at %>
                <%= "#{run.release_version} released on #{run.completed_at.to_s(:short)}" %>
              <% else %>
                <%= version_in_progress(run.release_version) %>
              <% end %>
            </span>
            <% if @train.active_run == run %>
              <span class="text-xs uppercase tracking-wider inline-flex font-medium bg-green-100 text-green-600 rounded-full text-center px-2 py-0.5 ml-2">
                Ongoing
              </span>
            <% end %>
          <% end %>
        <% end %>
        <% row.with_cell do %>
          <%= run.branch_name %>
        <% end %>
        <% row.with_cell do %>
          <%= @train.final_deployment_channel.display || "â€“" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% else %>
  <h2 class="text-2xl font-bold mt-8 mb-4">Releases</h2>
  <p class="text-sm">
    No releases yet.
  </p>
<% end %>
