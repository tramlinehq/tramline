<% url = train.new_record? ? app_trains_path(app) : app_train_path(app, train) %>
<%= form_with(model: [app, train], url: url) do |form| %>
  <div class="mb-8">
    <% if train.new_record? %>
      <h1 class="text-2xl md:text-3xl text-slate-800 font-bold">Create a new train ðŸš¦</h1>
    <% else %>
      <h1 class="text-2xl md:text-3xl text-slate-800 font-bold">Settings: <%= @train.name %></h1>
    <% end %>
  </div>

  <div class="border-t my-8"></div>

  <div class="grid gap-5 md:grid-cols-2">
    <div>
      <%= form.label :name, class: "block text-sm font-medium mb-1" %>
      <%= form.text_field :name, class: "form-input w-full", placeholder: "Enter train name...", required: true %>
    </div>
    <div>
      <%= form.label :description, class: "block text-sm font-medium mb-1" %>
      <%= form.text_area :description, class: "form-input w-full h-24", placeholder: "Describe the purpose of your train..." %>
    </div>
    <div>
      <%= form.label :version_seeded_with, class: "block text-sm font-medium mb-1" %>
      <%= form.text_field :version_seeded_with, class: "form-input w-full", placeholder: "only in semver format, eg., 1.2.0", required: true %>
    </div>
    <div>
      <%= form.label :version_suffix, class: "block text-sm font-medium mb-1" %>
      <%= form.text_field :version_suffix, class: "form-input w-full", placeholder: "eg., nightly, prod", required: true %>
    </div>
  </div>

  <div class="text-xl text-slate-600 font-medium mt-8 mb-2">Sign-off groups</div>
  <div>
    <%= form.select :sign_off_group_ids,
                    options_for_select(app.sign_off_groups.map { |group| [group.name, group.id] }, train.sign_off_groups.pluck(:id)),
                    { required: true },
                    { class: "form-input w-1/2", multiple: true, id: "slim-select", data: { controller: "input-select" } } %>
  </div>

  <div class="text-xl text-slate-600 font-medium mt-8 mb-2">Branching strategy</div>
  <div class="grid gap-5 md:grid-cols-2">
    <div data-controller="branching-selector">
      <%= form.label "Strategy", class: "block text-sm font-medium mb-1" %>
      <%= form.select :branching_strategy,
                      options_for_select(Releases::Train::BRANCHING_STRATEGIES.invert, train.branching_strategy),
                      { required: true, },
                      { class: "form-input w-full mb-1", data: { action: 'branching-selector#change' }, disabled: train.persisted? } %>
    </div>

    <div>
      <%= form.label :working_branch, class: "block text-sm font-medium mb-1" %>
      <%= form.text_field :working_branch, class: "form-input w-full", placeholder: "eg., master, main", disabled: train.persisted? %>
    </div>

    <div class="almost_trunk hidden">
    </div>

    <div class="pratul-make-sensible-grid"></div>

    <div class="release_backmerge hidden">
      <div>
        <%= form.label :release_backmerge_branch, class: "block text-sm font-medium mb-1" %>
        <%= form.text_field :release_backmerge_branch, class: "form-input w-full", placeholder: "eg., dev", disabled: train.persisted? %>
      </div>
    </div>

    <div class="parallel_working hidden">
      <div>
        <%= form.label :release_branch, class: "block text-sm font-medium mb-1" %>
        <%= form.text_field :release_branch, class: "form-input w-full", placeholder: "eg., production", disabled: train.persisted? %>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <%= form.submit class: "btn bg-indigo-500 hover:bg-indigo-600 text-white" do %>
      <svg class="w-4 h-4 fill-current opacity-50 shrink-0" viewBox="0 0 16 16">
        <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z"/>
      </svg>
    <% end %>
  </div>
<% end %>

<% if @train.steps.size > 0 && @train.persisted? %>
  <div class="text-2xl font-bold mt-8 mb-4 pt-4 border-t border-dashed">Steps</div>

  <ul>
    <% @train.steps.order(:step_number).each do |step| %>
      <li class="relative pb-6">
        <div class="flex items-center">
          <div class="absolute left-0 h-full w-0.5 bg-slate-200 self-start ml-2.5 -translate-x-1/2 translate-y-3" aria-hidden="true"></div>
          <div class="absolute left-0 rounded-full bg-indigo-200" aria-hidden="true">
            <svg class="w-5 h-5 fill-current text-slate-500" viewBox="0 0 20 20"/>
          </div>

          <div class="pl-9">
            <% if @train.active_run.blank? %>
              <%= link_to edit_step_path(step) do %>
                <button class="btn-sm bg-amber-200/75 hover:border-stone-400 text-slate-600">
                  <svg class="w-4 h-4 fill-current text-slate-500 shrink-0" viewBox="0 0 16 16">
                    <path d="M11.7.3c-.4-.4-1-.4-1.4 0l-10 10c-.2.2-.3.4-.3.7v4c0 .6.4 1 1 1h4c.3 0 .5-.1.7-.3l10-10c.4-.4.4-1 0-1.4l-4-4zM4.6 14H2v-2.6l6-6L10.6 8l-6 6zM12 6.6L9.4 4 11 2.4 13.6 5 12 6.6z"></path>
                  </svg>
                  <span class="ml-2">Edit step: <%= step.name %></span>
                </button>
              <% end %>
            <% else %>
              <%= link_to edit_step_path(step) do %>
                <button class="btn-sm bg-indigo-500 hover:bg-indigo-600 text-white disabled:border-slate-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed shadow-none" disabled="disabled">
                  <svg class="w-4 h-4 fill-current text-slate-500 shrink-0" viewBox="0 0 16 16">
                    <path d="M11.7.3c-.4-.4-1-.4-1.4 0l-10 10c-.2.2-.3.4-.3.7v4c0 .6.4 1 1 1h4c.3 0 .5-.1.7-.3l10-10c.4-.4.4-1 0-1.4l-4-4zM4.6 14H2v-2.6l6-6L10.6 8l-6 6zM12 6.6L9.4 4 11 2.4 13.6 5 12 6.6z"></path>
                  </svg>
                  <span class="ml-2">Edit step: <%= step.name %></span>
                </button>
              <% end %>
            <% end %>
          </div>
        </div>

        <div class="pl-9 my-3 flex flex-col">
          <span class="text-slate-400"><%= simple_format(step.description) %></span>
          <span class="pt-1.5 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-crane mr-1" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M6 21h6"/>
              <path d="M9 21v-18l-6 6h18"/>
              <path d="M9 3l10 6"/>
              <path d="M17 9v4a2 2 0 1 1 -2 2"/>
            </svg>
            <%= step.ci_cd_channel&.values&.first %>
          </span>
        </div>

      </li>
    <% end %>

    <% unless train.active_run %>
      <li class="relative ">
        <div class="flex items-center mb-1">
          <div class="absolute left-0 rounded-full bg-white" aria-hidden="true">
            <svg class="w-5 h-5 fill-current text-slate-400" viewBox="0 0 20 20">
              <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 2C4.477 20 0 15.523 0 10S4.477 0 10 0s10 4.477 10 10-4.477 10-10 10z"/>
            </svg>
          </div>
          <div class="pl-9">
            <%= link_to new_app_train_step_path(@app, @train) do %>
              <button class="btn-sm bg-green-600 hover:bg-green-700 text-white">
                <svg class="w-4 h-4 fill-current opacity-50 shrink-0" viewBox="0 0 16 16">
                  <path d="M15 7H9V1c0-.6-.4-1-1-1S7 .4 7 1v6H1c-.6 0-1 .4-1 1s.4 1 1 1h6v6c0 .6.4 1 1 1s1-.4 1-1V9h6c.6 0 1-.4 1-1s-.4-1-1-1z"></path>
                </svg>
                <span class="ml-2">Add another step</span>
              </button>
            <% end %>
          </div>
        </div>
      </li>
  <% end %>
  </ul>
<% elsif @train.persisted? %>
  <div class="m-1.5">
    <button class="btn-sm bg-indigo-500 hover:bg-indigo-600 text-white">
      <%= link_to "Add a step", new_app_train_step_path(@app, @train) %>
    </button>
  </div>
<% end %>
